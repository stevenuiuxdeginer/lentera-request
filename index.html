<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lentera Request - Aplikasi Pengajuan Barang & Perbaikan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#E0F2FE',
                        accent: '#0EA5E9'
                    }
                }
            }
        }
    </script>
    <style>
        .card-shadow {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .card-shadow:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-white min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-lg flex items-center justify-center">
                        <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <h1 class="text-xl font-bold text-gray-800">Lentera Request</h1>
                </div>
                <nav class="hidden md:flex space-x-6">
                    <button onclick="showPage('home')" class="nav-btn text-primary font-medium hover:text-accent transition-colors">Ajukan Permintaan</button>
                    <button onclick="showPage('history')" class="nav-btn text-gray-600 font-medium hover:text-primary transition-colors">Riwayat</button>
                </nav>
                <button class="md:hidden p-2" onclick="toggleMobileMenu()">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                    </svg>
                </button>
            </div>
            <!-- Mobile Menu -->
            <div id="mobileMenu" class="hidden md:hidden mt-4 pb-4 border-t">
                <button onclick="showPage('home')" class="block w-full text-left py-2 text-primary font-medium">Ajukan Permintaan</button>
                <button onclick="showPage('history')" class="block w-full text-left py-2 text-gray-600 font-medium">Riwayat</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Home Page -->
        <div id="homePage" class="page-content">
            <!-- Hero Section -->
            <section class="text-center mb-12 fade-in">
                <h2 class="text-4xl md:text-5xl font-bold text-gray-800 mb-4">
                    Aplikasi Pengajuan<br>
                    <span class="text-primary">Barang & Perbaikan</span>
                </h2>
                <p class="text-lg text-gray-600 max-w-2xl mx-auto">
                    Ajukan permintaan barang atau perbaikan dengan mudah dan pantau statusnya secara real-time
                </p>
            </section>

            <!-- Request Form -->
            <section class="max-w-2xl mx-auto">
                <div class="bg-white rounded-2xl card-shadow p-8 fade-in">
                    <h3 class="text-2xl font-bold text-gray-800 mb-6 text-center">Form Ajukan Permintaan</h3>
                    <form id="requestForm" class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Pengaju</label>
                            <input type="text" id="namaPengaju" required 
                                   class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jenis Pengajuan</label>
                            <select id="jenisPengajuan" required 
                                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                                <option value="">Pilih Jenis Pengajuan</option>
                                <option value="Barang">Barang</option>
                                <option value="Perbaikan">Perbaikan</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Deskripsi Kebutuhan</label>
                            <textarea id="deskripsi" required rows="4" 
                                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all"
                                      placeholder="Jelaskan kebutuhan Anda secara detail..."></textarea>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tanggal Pengajuan</label>
                                <input type="date" id="tanggalPengajuan" required 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent transition-all">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                                <input type="text" value="Menunggu" readonly 
                                       class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-50">
                            </div>
                        </div>
                        
                        <button type="submit" 
                                class="w-full bg-primary hover:bg-blue-600 text-white font-medium py-4 px-6 rounded-lg transition-all transform hover:scale-105 focus:ring-4 focus:ring-blue-200">
                            <span class="flex items-center justify-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Ajukan Permintaan
                            </span>
                        </button>
                    </form>
                </div>
            </section>
        </div>



        <!-- History Page -->
        <div id="historyPage" class="page-content hidden">
            <section class="fade-in">
                <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-4 lg:mb-0">Riwayat Permintaan</h2>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="loadHistory()" 
                                class="bg-primary hover:bg-blue-600 text-white px-4 py-2 rounded-lg transition-colors flex items-center">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>

                <!-- Filters Section -->
                <div class="bg-white rounded-xl card-shadow p-6 mb-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-800">Filter & Pencarian</h3>
                        <button onclick="clearAllFilters()" 
                                class="text-sm text-gray-600 hover:text-primary transition-colors">
                            Reset Filter
                        </button>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <!-- Search Input -->
                        <div class="relative">
                            <input type="text" id="searchInput" placeholder="Cari nama, ID, atau deskripsi..." 
                                   class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                            </svg>
                        </div>

                        <!-- Status Filter -->
                        <select id="statusFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">Semua Status</option>
                            <option value="Menunggu">Menunggu</option>
                            <option value="Dalam Proses">Dalam Proses</option>
                            <option value="Disetujui">Disetujui</option>
                            <option value="Selesai">Selesai</option>
                            <option value="Ditolak">Ditolak</option>
                        </select>

                        <!-- Jenis Filter -->
                        <select id="jenisFilter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent">
                            <option value="">Semua Jenis</option>
                            <option value="Barang">Barang</option>
                            <option value="Perbaikan">Perbaikan</option>
                        </select>

                        <!-- Date Range -->
                        <div class="flex space-x-2">
                            <input type="date" id="dateFrom" placeholder="Dari tanggal" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm">
                            <input type="date" id="dateTo" placeholder="Sampai tanggal" 
                                   class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-transparent text-sm">
                        </div>
                    </div>

                    <!-- Statistics -->
                    <div id="statisticsContainer" class="mt-6 grid grid-cols-2 md:grid-cols-6 gap-4">
                        <div class="bg-blue-50 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="totalCount">0</div>
                            <div class="text-sm text-blue-800">Total</div>
                        </div>
                        <div class="bg-yellow-50 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-yellow-600" id="menungguCount">0</div>
                            <div class="text-sm text-yellow-800">Menunggu</div>
                        </div>
                        <div class="bg-blue-50 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-blue-600" id="prosesCount">0</div>
                            <div class="text-sm text-blue-800">Proses</div>
                        </div>
                        <div class="bg-green-50 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-green-600" id="disetujuiCount">0</div>
                            <div class="text-sm text-green-800">Disetujui</div>
                        </div>
                        <div class="bg-emerald-50 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-emerald-600" id="selesaiCount">0</div>
                            <div class="text-sm text-emerald-800">Selesai</div>
                        </div>
                        <div class="bg-red-50 rounded-lg p-3 text-center">
                            <div class="text-2xl font-bold text-red-600" id="ditolakCount">0</div>
                            <div class="text-sm text-red-800">Ditolak</div>
                        </div>
                    </div>
                </div>
                
                <!-- Table Container -->
                <div class="bg-white rounded-xl card-shadow overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead class="bg-primary text-white">
                                <tr>
                                    <th class="px-4 py-3 text-left text-sm font-medium cursor-pointer hover:bg-blue-600 transition-colors" onclick="sortTable('idTransaksi')">
                                        ID Transaksi
                                        <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-medium cursor-pointer hover:bg-blue-600 transition-colors" onclick="sortTable('tanggalPengajuan')">
                                        Tanggal
                                        <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-medium cursor-pointer hover:bg-blue-600 transition-colors" onclick="sortTable('namaPengaju')">
                                        Nama Pengaju
                                        <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-medium cursor-pointer hover:bg-blue-600 transition-colors" onclick="sortTable('jenisPengajuan')">
                                        Jenis
                                        <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-medium">Deskripsi</th>
                                    <th class="px-4 py-3 text-left text-sm font-medium cursor-pointer hover:bg-blue-600 transition-colors" onclick="sortTable('status')">
                                        Status
                                        <svg class="w-4 h-4 inline ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                    </th>
                                    <th class="px-4 py-3 text-left text-sm font-medium">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody">
                                <tr>
                                    <td colspan="7" class="px-4 py-8 text-center">
                                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                                        <p class="text-gray-600">Memuat data...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Pagination -->
                    <div id="paginationContainer" class="bg-gray-50 px-4 py-3 border-t border-gray-200 flex items-center justify-between">
                        <div class="text-sm text-gray-700">
                            Menampilkan <span id="showingFrom">0</span> - <span id="showingTo">0</span> dari <span id="totalRecords">0</span> data
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="changePage(-1)" id="prevBtn" 
                                    class="px-3 py-1 bg-white border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Sebelumnya
                            </button>
                            <div id="pageNumbers" class="flex space-x-1"></div>
                            <button onclick="changePage(1)" id="nextBtn" 
                                    class="px-3 py-1 bg-white border border-gray-300 rounded-md text-sm hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                                Selanjutnya
                            </button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <!-- Success Modal -->
    <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg class="w-8 h-8 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
            </div>
            <h3 class="text-xl font-bold text-gray-800 mb-2">Berhasil!</h3>
            <p class="text-gray-600 mb-6">Permintaan Anda telah berhasil disimpan ke Google Sheets</p>
            <button onclick="closeModal()" 
                    class="bg-primary hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                Tutup
            </button>
        </div>
    </div>

    <script>
        // Google Apps Script URL
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwVJDuWF_tX8h7v2PoeLLwye7K73hCJ0I--5CqQ77Vcy1ISzGTPj8iWBUfNE2Kodrk/exec';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setCurrentDate();
            loadHistory();
        });

        // Set current date
        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('tanggalPengajuan').value = today;
        }

        // Navigation
        function showPage(page) {
            document.querySelectorAll('.page-content').forEach(p => p.classList.add('hidden'));
            document.getElementById(page + 'Page').classList.remove('hidden');
            
            // Update nav buttons
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('text-primary');
                btn.classList.add('text-gray-600');
            });
            event.target.classList.remove('text-gray-600');
            event.target.classList.add('text-primary');
            
            if (page === 'history') {
                loadHistory();
            }
        }

        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }

        // Generate Transaction ID
        function generateTransactionId() {
            const today = new Date();
            const dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
            const randomNum = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            return `SLHLB-REQ-${dateStr}-${randomNum}`;
        }

        // Form submission with Google Sheets integration
        document.getElementById('requestForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitButton = e.target.querySelector('button[type="submit"]');
            const originalText = submitButton.innerHTML;
            
            // Show loading state
            submitButton.innerHTML = `
                <div class="flex items-center justify-center">
                    <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
                    Mengirim ke Google Sheets...
                </div>
            `;
            submitButton.disabled = true;
            
            const formData = {
                action: 'submit',
                idTransaksi: generateTransactionId(),
                tanggalPengajuan: document.getElementById('tanggalPengajuan').value,
                namaPengaju: document.getElementById('namaPengaju').value,
                jenisPengajuan: document.getElementById('jenisPengajuan').value,
                deskripsi: document.getElementById('deskripsi').value,
                status: 'Menunggu',
                tanggalUpdateStatus: new Date().toISOString().split('T')[0],
                keteranganAdmin: ''
            };

            try {
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData),
                    mode: 'no-cors' // Required for Google Apps Script
                });
                
                console.log('Data berhasil dikirim ke Google Sheets:', formData);
                
                // Show success modal
                document.getElementById('successModal').classList.remove('hidden');
                document.getElementById('successModal').classList.add('flex');
                
                // Reset form
                document.getElementById('requestForm').reset();
                setCurrentDate();
                
                // Refresh history after successful submission
                setTimeout(() => {
                    if (!document.getElementById('historyPage').classList.contains('hidden')) {
                        loadHistory();
                    }
                }, 2000);
                
            } catch (error) {
                alert('Terjadi kesalahan saat mengirim data ke Google Sheets: ' + error.message);
                console.error('Error:', error);
            } finally {
                // Reset button
                submitButton.innerHTML = originalText;
                submitButton.disabled = false;
            }
        });

        // Global variables for table functionality
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        let itemsPerPage = 10;
        let sortColumn = '';
        let sortDirection = 'asc';



        // Load history from Google Sheets
        async function loadHistory() {
            const tableBody = document.getElementById('historyTableBody');
            
            // Show loading
            tableBody.innerHTML = `
                <tr>
                    <td colspan="7" class="px-4 py-8 text-center">
                        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-primary mx-auto mb-4"></div>
                        <p class="text-gray-600">Memuat data dari Google Sheets...</p>
                    </td>
                </tr>
            `;
            
            try {
                const response = await fetch(APPS_SCRIPT_URL + '?action=get');
                const result = await response.json();
                
                if (result.success) {
                    allData = result.data;
                    applyFilters();
                } else {
                    throw new Error(result.message || 'Gagal memuat data');
                }
                
            } catch (error) {
                console.error('Error loading history:', error);
                
                // Show demo data as fallback
                allData = [
                    {
                        idTransaksi: 'SLHLB-REQ-20241201-001',
                        namaPengaju: 'Ahmad Rizki',
                        jenisPengajuan: 'Barang',
                        deskripsi: 'Laptop untuk keperluan kerja divisi IT',
                        status: 'Selesai',
                        tanggalPengajuan: '2024-12-01',
                        keteranganAdmin: 'Laptop telah diterima dan siap digunakan'
                    },
                    {
                        idTransaksi: 'SLHLB-REQ-20241130-002',
                        namaPengaju: 'Siti Nurhaliza',
                        jenisPengajuan: 'Perbaikan',
                        deskripsi: 'Perbaikan AC ruang meeting lantai 2',
                        status: 'Dalam Proses',
                        tanggalPengajuan: '2024-11-30',
                        keteranganAdmin: 'Sedang menunggu teknisi'
                    },
                    {
                        idTransaksi: 'SLHLB-REQ-20241129-003',
                        namaPengaju: 'Budi Santoso',
                        jenisPengajuan: 'Barang',
                        deskripsi: 'Printer untuk divisi keuangan',
                        status: 'Disetujui',
                        tanggalPengajuan: '2024-11-29',
                        keteranganAdmin: 'Disetujui untuk pembelian'
                    },
                    {
                        idTransaksi: 'SLHLB-REQ-20241128-004',
                        namaPengaju: 'Maya Sari',
                        jenisPengajuan: 'Perbaikan',
                        deskripsi: 'Perbaikan lampu ruang kerja',
                        status: 'Ditolak',
                        tanggalPengajuan: '2024-11-28',
                        keteranganAdmin: 'Budget tidak tersedia'
                    },
                    {
                        idTransaksi: 'SLHLB-REQ-20241127-005',
                        namaPengaju: 'Andi Pratama',
                        jenisPengajuan: 'Barang',
                        deskripsi: 'Kursi ergonomis untuk workstation',
                        status: 'Menunggu',
                        tanggalPengajuan: '2024-11-27',
                        keteranganAdmin: ''
                    }
                ];
                
                // Show warning message
                const warningRow = `
                    <tr>
                        <td colspan="7" class="px-4 py-3">
                            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.732 16c-.77.833.192 2.5 1.732 2.5z"></path>
                                    </svg>
                                    <p class="text-yellow-800 text-sm">
                                        Tidak dapat terhubung ke Google Sheets. Menampilkan data demo.
                                    </p>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
                
                applyFilters();
            }
        }

        // Apply all filters and update display
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;
            const jenisFilter = document.getElementById('jenisFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;

            filteredData = allData.filter(item => {
                // Search filter
                const searchMatch = !searchTerm || 
                    (item.idTransaksi || '').toLowerCase().includes(searchTerm) ||
                    (item.namaPengaju || '').toLowerCase().includes(searchTerm) ||
                    (item.deskripsi || '').toLowerCase().includes(searchTerm);

                // Status filter
                const statusMatch = !statusFilter || item.status === statusFilter;

                // Jenis filter
                const jenisMatch = !jenisFilter || item.jenisPengajuan === jenisFilter;

                // Date range filter
                const itemDate = item.tanggalPengajuan;
                const dateFromMatch = !dateFrom || itemDate >= dateFrom;
                const dateToMatch = !dateTo || itemDate <= dateTo;

                return searchMatch && statusMatch && jenisMatch && dateFromMatch && dateToMatch;
            });

            // Apply sorting
            if (sortColumn) {
                filteredData.sort((a, b) => {
                    let aVal = a[sortColumn] || '';
                    let bVal = b[sortColumn] || '';
                    
                    if (sortColumn === 'tanggalPengajuan') {
                        aVal = new Date(aVal);
                        bVal = new Date(bVal);
                    }
                    
                    if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                    return 0;
                });
            }

            updateStatistics();
            updateTable();
            updatePagination();
        }

        // Update statistics
        function updateStatistics() {
            const stats = {
                total: filteredData.length,
                menunggu: filteredData.filter(item => item.status === 'Menunggu').length,
                proses: filteredData.filter(item => item.status === 'Dalam Proses').length,
                disetujui: filteredData.filter(item => item.status === 'Disetujui').length,
                selesai: filteredData.filter(item => item.status === 'Selesai').length,
                ditolak: filteredData.filter(item => item.status === 'Ditolak').length
            };

            document.getElementById('totalCount').textContent = stats.total;
            document.getElementById('menungguCount').textContent = stats.menunggu;
            document.getElementById('prosesCount').textContent = stats.proses;
            document.getElementById('disetujuiCount').textContent = stats.disetujui;
            document.getElementById('selesaiCount').textContent = stats.selesai;
            document.getElementById('ditolakCount').textContent = stats.ditolak;
        }

        // Update table display
        function updateTable() {
            const tableBody = document.getElementById('historyTableBody');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageData = filteredData.slice(startIndex, endIndex);

            if (pageData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center">
                            <svg class="w-16 h-16 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            <p class="text-gray-500">Tidak ada data yang sesuai dengan filter</p>
                        </td>
                    </tr>
                `;
                return;
            }

            tableBody.innerHTML = pageData.map((item, index) => `
                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-blue-50 transition-colors">
                    <td class="px-4 py-3 text-sm font-mono text-gray-600">${item.idTransaksi || item.idtransaksi || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">${formatDate(item.tanggalPengajuan || item.tanggalpengajuan)}</td>
                    <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.namaPengaju || item.namapengaju || '-'}</td>
                    <td class="px-4 py-3 text-sm text-gray-900">
                        <span class="px-2 py-1 rounded-full text-xs font-medium ${getJenisColor(item.jenisPengajuan || item.jenispengajuan)}">
                            ${item.jenisPengajuan || item.jenispengajuan || '-'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm text-gray-900 max-w-xs">
                        <div class="truncate" title="${item.deskripsi || '-'}">${item.deskripsi ? (item.deskripsi.length > 50 ? item.deskripsi.substring(0, 50) + '...' : item.deskripsi) : '-'}</div>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(item.status)}">
                            ${item.status || '-'}
                        </span>
                    </td>
                    <td class="px-4 py-3 text-sm">
                        <button onclick="viewDetail('${item.idTransaksi || item.idtransaksi}')" 
                                class="text-primary hover:text-blue-600 font-medium">
                            Detail
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // Update pagination
        function updatePagination() {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const startRecord = filteredData.length === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endRecord = Math.min(currentPage * itemsPerPage, filteredData.length);

            document.getElementById('showingFrom').textContent = startRecord;
            document.getElementById('showingTo').textContent = endRecord;
            document.getElementById('totalRecords').textContent = filteredData.length;

            // Update buttons
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;

            // Update page numbers
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';

            const maxVisiblePages = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisiblePages / 2));
            let endPage = Math.min(totalPages, startPage + maxVisiblePages - 1);

            if (endPage - startPage + 1 < maxVisiblePages) {
                startPage = Math.max(1, endPage - maxVisiblePages + 1);
            }

            for (let i = startPage; i <= endPage; i++) {
                const button = document.createElement('button');
                button.textContent = i;
                button.className = `px-3 py-1 text-sm rounded-md ${
                    i === currentPage 
                        ? 'bg-primary text-white' 
                        : 'bg-white border border-gray-300 hover:bg-gray-50'
                }`;
                button.onclick = () => goToPage(i);
                pageNumbers.appendChild(button);
            }
        }

        // Helper functions
        function getStatusColor(status) {
            switch(status) {
                case 'Disetujui': return 'bg-green-100 text-green-800';
                case 'Dalam Proses': return 'bg-yellow-100 text-yellow-800';
                case 'Selesai': return 'bg-emerald-100 text-emerald-800';
                case 'Ditolak': return 'bg-red-100 text-red-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function getJenisColor(jenis) {
            switch(jenis) {
                case 'Barang': return 'bg-blue-100 text-blue-800';
                case 'Perbaikan': return 'bg-purple-100 text-purple-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('id-ID', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        // Table functionality
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            applyFilters();
        }

        function goToPage(page) {
            currentPage = page;
            updateTable();
            updatePagination();
        }

        function changePage(direction) {
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const newPage = currentPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                goToPage(newPage);
            }
        }

        function clearAllFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('jenisFilter').value = '';
            document.getElementById('dateFrom').value = '';
            document.getElementById('dateTo').value = '';
            
            currentPage = 1;
            sortColumn = '';
            sortDirection = 'asc';
            
            applyFilters();
        }

        function exportToCSV() {
            if (filteredData.length === 0) {
                alert('Tidak ada data untuk diekspor');
                return;
            }

            const headers = ['ID Transaksi', 'Tanggal Pengajuan', 'Nama Pengaju', 'Jenis Pengajuan', 'Deskripsi', 'Status', 'Keterangan Admin'];
            const csvContent = [
                headers.join(','),
                ...filteredData.map(item => [
                    `"${item.idTransaksi || ''}"`,
                    `"${item.tanggalPengajuan || ''}"`,
                    `"${item.namaPengaju || ''}"`,
                    `"${item.jenisPengajuan || ''}"`,
                    `"${(item.deskripsi || '').replace(/"/g, '""')}"`,
                    `"${item.status || ''}"`,
                    `"${(item.keteranganAdmin || '').replace(/"/g, '""')}"`
                ].join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `riwayat-permintaan-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function viewDetail(idTransaksi) {
            const item = allData.find(data => (data.idTransaksi || data.idtransaksi) === idTransaksi);
            if (!item) return;

            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-xl font-bold text-gray-800">Detail Permintaan</h3>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="text-gray-400 hover:text-gray-600">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">ID Transaksi</label>
                                    <div class="text-sm font-mono bg-gray-50 p-2 rounded">${item.idTransaksi || item.idtransaksi || '-'}</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Pengajuan</label>
                                    <div class="text-sm bg-gray-50 p-2 rounded">${formatDate(item.tanggalPengajuan || item.tanggalpengajuan)}</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Nama Pengaju</label>
                                    <div class="text-sm bg-gray-50 p-2 rounded">${item.namaPengaju || item.namapengaju || '-'}</div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Jenis Pengajuan</label>
                                    <div class="text-sm bg-gray-50 p-2 rounded">
                                        <span class="px-2 py-1 rounded-full text-xs font-medium ${getJenisColor(item.jenisPengajuan || item.jenispengajuan)}">
                                            ${item.jenisPengajuan || item.jenispengajuan || '-'}
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Deskripsi</label>
                                <div class="text-sm bg-gray-50 p-3 rounded min-h-[80px]">${item.deskripsi || '-'}</div>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                                    <div class="text-sm bg-gray-50 p-2 rounded">
                                        <span class="px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(item.status)}">
                                            ${item.status || '-'}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal Update</label>
                                    <div class="text-sm bg-gray-50 p-2 rounded">${formatDate(item.tanggalUpdateStatus || item.tanggalupdatestatus) || '-'}</div>
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Keterangan Admin</label>
                                <div class="text-sm bg-gray-50 p-3 rounded min-h-[60px]">${item.keteranganAdmin || item.keteranganadmin || 'Belum ada keterangan'}</div>
                            </div>
                        </div>
                        
                        <div class="mt-6 flex justify-end">
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="bg-primary hover:bg-blue-600 text-white px-6 py-2 rounded-lg transition-colors">
                                Tutup
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }





        function showSuccessMessage(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform';
            toast.innerHTML = `
                <div class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(toast);
            
            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 100);
            
            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        // Event listeners for filters
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('jenisFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFrom').addEventListener('change', applyFilters);
            document.getElementById('dateTo').addEventListener('change', applyFilters);


        });

        // Close modal
        function closeModal() {
            document.getElementById('successModal').classList.add('hidden');
            document.getElementById('successModal').classList.remove('flex');
        }
    </script>


<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9760602a2752a0bc',t:'MTc1NjM0ODExMC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
